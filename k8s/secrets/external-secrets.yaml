# =====================================================
# EXTERNAL SECRETS OPERATOR CONFIGURATION
# Integration with HashiCorp Vault & AWS Secrets Manager
# =====================================================

# External Secrets Operator - SecretStore for HashiCorp Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: movie-booking
spec:
  provider:
    vault:
      server: "https://vault.movie-booking.svc:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "movie-booking-role"
          serviceAccountRef:
            name: "movie-booking-sa"
---
# External Secrets Operator - SecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: movie-booking
spec:
  provider:
    aws:
      service: SecretsManager
      region: ap-southeast-1
      auth:
        jwt:
          serviceAccountRef:
            name: movie-booking-sa
---
# ExternalSecret for Database Credentials (Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-secrets
  namespace: movie-booking
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: database-secrets
    creationPolicy: Owner
  data:
    # Auth Service Database
    - secretKey: AUTH_DATABASE_URL
      remoteRef:
        key: movie-booking/auth-service
        property: database_url
    
    # Movie Service Database
    - secretKey: MOVIE_DATABASE_URL
      remoteRef:
        key: movie-booking/movie-service
        property: database_url
    
    # Booking Service Database
    - secretKey: BOOKING_DATABASE_URL
      remoteRef:
        key: movie-booking/booking-service
        property: database_url
    
    # Payment Service Database
    - secretKey: PAYMENT_DATABASE_URL
      remoteRef:
        key: movie-booking/payment-service
        property: database_url
    
    # Notification Service Database
    - secretKey: NOTIFICATION_DATABASE_URL
      remoteRef:
        key: movie-booking/notification-service
        property: database_url
---
# ExternalSecret for Infrastructure Credentials (Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: infra-secrets
  namespace: movie-booking
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: infra-secrets
    creationPolicy: Owner
  data:
    # Redis Password
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: movie-booking/redis
        property: password
    
    # RabbitMQ Credentials
    - secretKey: RABBITMQ_USER
      remoteRef:
        key: movie-booking/rabbitmq
        property: username
    - secretKey: RABBITMQ_PASSWORD
      remoteRef:
        key: movie-booking/rabbitmq
        property: password
---
# ExternalSecret for Application Secrets (Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-secrets-external
  namespace: movie-booking
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: app-secrets
    creationPolicy: Owner
  data:
    # JWT Secret Key (rotated)
    - secretKey: SECRET_KEY
      remoteRef:
        key: movie-booking/jwt
        property: secret_key
    
    # Service-to-Service Token
    - secretKey: SERVICE_AUTH_TOKEN
      remoteRef:
        key: movie-booking/internal
        property: service_token
    
    # SMTP Configuration
    - secretKey: SMTP_HOST
      remoteRef:
        key: movie-booking/smtp
        property: host
    - secretKey: SMTP_PORT
      remoteRef:
        key: movie-booking/smtp
        property: port
    - secretKey: SMTP_USER
      remoteRef:
        key: movie-booking/smtp
        property: username
    - secretKey: SMTP_PASSWORD
      remoteRef:
        key: movie-booking/smtp
        property: password
---
# ExternalSecret for Docker Registry (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: docker-registry-external
  namespace: movie-booking
spec:
  refreshInterval: 12h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: docker-registry-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ .dockerconfig | toString }}"
  data:
    - secretKey: dockerconfig
      remoteRef:
        key: movie-booking/docker-registry
        property: config
