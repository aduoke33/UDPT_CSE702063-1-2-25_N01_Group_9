sequenceDiagram
    participant U as User
    participant GW as Gateway
    participant A as Auth
    participant M as Movie
    participant B as Booking
    participant R as Redis
    participant P as Payment
    participant N as Notification

    Note over U,N: 1. User Authentication
    U->>GW: POST /api/auth/token
    GW->>A: Forward login request
    A->>A: Verify credentials
    A-->>U: JWT Token

    Note over U,N: 2. Browse Movies
    U->>GW: GET /api/movies/showtimes
    GW->>M: Get available showtimes
    M-->>U: List of movies and times

    Note over U,N: 3. Book Seats
    U->>GW: POST /api/bookings/book
    GW->>B: Create booking request
    
    B->>R: SETNX lock:seat:A1
    R-->>B: OK (locked)
    B->>R: SETNX lock:seat:A2
    R-->>B: OK (locked)
    
    B->>B: Save booking to database
    B-->>U: Booking created (pending)

    Note over U,N: 4. Process Payment
    U->>GW: POST /api/payments/process
    GW->>P: Process payment
    P->>R: Check idempotency key
    R-->>P: Not exists
    P->>P: Charge payment
    P->>R: Store idempotency key
    P-->>B: Payment completed

    Note over U,N: 5. Confirm and Notify
    B->>B: Update status to confirmed
    B->>N: Publish booking.confirmed event
    N->>N: Send confirmation email
    N-->>U: Email: Your tickets are ready
